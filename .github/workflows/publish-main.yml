name: Publish Package (Production)

on:
  push:
    branches:
      - main

jobs:
  mirror-and-publish:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ── Mirror to Public Repo ──────────────────────────────────
      - name: Push to public repo
        run: |
          git remote add public https://x-access-token:${{ secrets.CLIENT_LIBRARY_NUGET_AUTH_TOKEN }}@github.com/${{ vars.PUBLIC_REPO }}.git
          git push public main --force

      # ── Build & Publish to Public Account ──────────────────────
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Authenticate GitHub Packages
        run: |
          dotnet nuget remove source githubanddone --configfile src/AndDoneSecureClientLibrary/nuget.config
          dotnet nuget add source \
            --username ${{ github.repository_owner }} \
            --password ${{ secrets.CLIENT_LIBRARY_NUGET_AUTH_TOKEN }} \
            --store-password-in-clear-text \
            --name githubanddone \
            --configfile src/AndDoneSecureClientLibrary/nuget.config \
            "https://nuget.pkg.github.com/AndDone-LLC/index.json"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --configuration Release --no-restore --no-build

      - name: Pack
        run: dotnet pack --configuration Release --no-build --output ./nupkg /p:RepositoryUrl=https://github.com/anddone-kit/AndDone-SecureAPI-ClientLibrary-DotNet.git

      - name: Push to GitHub Packages (Public)
        run: |
          PUBLIC_OWNER=$(echo "${{ vars.PUBLIC_REPO }}" | cut -d'/' -f1)

          dotnet nuget push ./nupkg/*.nupkg \
            --api-key ${{ secrets.CLIENT_LIBRARY_NUGET_AUTH_TOKEN }} \
            --source "https://nuget.pkg.github.com/$PUBLIC_OWNER/index.json" \
            --skip-duplicate